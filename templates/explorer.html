{% extends 'base.html' %}

{% block title %}Vault - Cloud Vault{% endblock %}

{% block content %}
  <div class="flex-1 min-h-0 flex flex-col">
    <div class="minimal-card p-3 shrink-0">
      <div class="flex items-center gap-3 flex-wrap">
        <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" onclick="window.history.back()" title="Back">
          <span class="iconify" data-icon="mdi:arrow-left"></span>
        </button>

      <div class="flex-1 min-w-[240px]">
        <div class="flex items-center gap-2 border border-slate-200 rounded-xl px-3 py-2 bg-white">
          <span class="iconify text-slate-400" data-icon="mdi:folder-outline"></span>
          <div class="text-sm text-slate-700 flex items-center gap-1 flex-wrap">
            {% for label, href in breadcrumbs %}
              <a class="font-semibold hover:underline" href="{{ href }}">{{ label }}</a>
              {% if not loop.last %}
                <span class="text-slate-400">›</span>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="flex-1 min-w-[240px]">
        <form method="get" action="{{ url_for('search') }}">
          <div class="flex items-center gap-2">
            <div class="flex-1 flex items-center gap-2 border border-slate-200 rounded-xl px-3 py-2 bg-white">
              <span class="iconify text-slate-400" data-icon="mdi:magnify"></span>
              <div class="relative w-full">
                <input class="w-full text-sm focus:outline-none" id="explorer-search-input" name="q" placeholder="Search Vault" autocomplete="off" />
                <div id="explorer-live-results" class="hidden absolute left-0 right-0 top-full mt-2 minimal-card p-2 shadow-lg z-30 max-h-96 overflow-auto"></div>
              </div>
              <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" onclick="toggleExplorerAdvancedSearch()" title="Advanced search">
                <span class="iconify" data-icon="mdi:tune-vertical"></span>
              </button>
              <button class="minimal-btn minimal-btn-primary" type="submit" title="Search">
                <span class="iconify" data-icon="mdi:arrow-right"></span>
              </button>
            </div>
          </div>

          <div id="explorer-advanced" class="hidden mt-2">
            <div class="grid grid-cols-2 gap-2">
              <input class="minimal-input" style="padding:.55rem .75rem" name="ext" placeholder="Extension (pdf)" />
              <input class="minimal-input" style="padding:.55rem .75rem" name="filetype" placeholder="Filetype (image/)" />
              <input class="minimal-input" style="padding:.55rem .75rem" type="date" name="date_from" />
              <input class="minimal-input" style="padding:.55rem .75rem" type="date" name="date_to" />
            </div>
          </div>
        </form>
      </div>

      <div class="relative">
        <button class="minimal-btn minimal-btn-primary" type="button" onclick="toggleExplorerNewMenu()">
          <span class="iconify" data-icon="mdi:plus"></span>
          <span>New</span>
        </button>

        <div id="explorer-new-menu" class="hidden absolute right-0 mt-2 w-96 z-10">
          <div class="minimal-card p-4">
            <div class="text-xs uppercase tracking-wider text-slate-500 mb-3">New folder</div>
            <form class="flex gap-3 ajax-form" method="post" action="{{ url_for('create_folder') }}" data-ajax="json">
              <input type="hidden" name="parent_id" id="new-folder-parent-id" value="{{ selected_folder_id or root_folder_id or '' }}" />
              <input class="minimal-input" id="new-folder-input" name="name" placeholder="Folder name" required />
              <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="submit">
                <span class="iconify" data-icon="mdi:folder-plus-outline"></span>
                <span>Create</span>
              </button>
            </form>

            <div class="mt-5 text-xs uppercase tracking-wider text-slate-500 mb-3">Upload file</div>
            <form class="space-y-3 ajax-form" method="post" enctype="multipart/form-data" action="{{ url_for('upload_any') }}" data-ajax="multipart">
              <select class="minimal-input" name="folder_id" required>
                {% if root_folder_id %}
                  <option value="{{ root_folder_id }}" {% if not selected_folder_id %}selected{% endif %}>Vault (root)</option>
                {% endif %}
                <option value="" disabled {% if selected_folder_id %}selected{% endif %}>Select folder</option>
                {% for folder in all_folders %}
                  {% if folder.id != root_folder_id %}
                    <option value="{{ folder.id }}" {% if selected_folder_id == folder.id %}selected{% endif %}>{{ folder.name }}</option>
                  {% endif %}
                {% endfor %}
              </select>
              <input class="minimal-input" id="new-upload-file-input" type="file" name="file" required />
              <button class="minimal-btn w-full minimal-btn-primary" type="submit">
                <span class="iconify" data-icon="mdi:upload"></span>
                <span>Upload</span>
              </button>
            </form>
          </div>
        </div>
      </div>

      </div>
    </div>

    <div class="mt-6 minimal-card overflow-hidden flex-1 flex flex-col min-h-0">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between shrink-0">
        <div class="font-semibold text-slate-900 flex items-center gap-3" id="current-folder-pin" data-current-folder-id="{{ selected_folder.id if selected_folder else '' }}">
          {% if selected_folder %}
            <span>{{ selected_folder.name }}</span>
            {% if selected_folder.is_bookmarked %}
              <form method="post" class="ajax-form" data-ajax="json" action="{{ url_for('unbookmark_folder', folder_id=selected_folder.id) }}">
                <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="submit" title="Remove from Quick access">
                  <span class="iconify" data-icon="mdi:bookmark-remove-outline"></span>
                  <span>Unpin</span>
                </button>
              </form>
            {% else %}
              <form method="post" class="ajax-form" data-ajax="json" action="{{ url_for('bookmark_folder', folder_id=selected_folder.id) }}">
                <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="submit" title="Add to Quick access">
                  <span class="iconify" data-icon="mdi:bookmark-outline"></span>
                  <span>Pin</span>
                </button>
              </form>
            {% endif %}
          {% else %}
            <span>Folders</span>
          {% endif %}
        </div>
      <div class="text-xs text-slate-500">
        {% if selected_folder %}
          Files in this folder
        {% else %}
          Double-click a folder to open
        {% endif %}
      </div>
    </div>

      <div class="flex-1 min-h-0 overflow-auto" id="explorer-content-area">

      <div id="explorer-folders-details" class="divide-y divide-slate-200">
        {% for folder in folders %}
          <div class="px-4 py-3 flex items-center justify-between gap-4 hover:bg-slate-50" data-folder-row="{{ folder.id }}" data-folder-name="{{ folder.name }}" data-folder-bookmarked="{{ 1 if folder.is_bookmarked else 0 }}" data-selectable="folder" data-open-url="{{ url_for('folder_view', folder_id=folder.id) }}">
            <a class="flex items-center gap-3 min-w-0 flex-1" href="{{ url_for('folder_view', folder_id=folder.id) }}">
              <div class="w-8 h-8 rounded-xl bg-indigo-50 text-indigo-700 flex items-center justify-center">
                <span class="iconify" data-icon="mdi:folder-outline"></span>
              </div>
              <div class="min-w-0">
                <div class="font-semibold text-slate-900 truncate" data-folder-title>{{ folder.name }}</div>
                <div class="text-xs text-slate-500" data-folder-subtitle>Created {{ folder.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
              </div>
            </a>

            <div class="flex items-center gap-2">
              {% if folder.is_bookmarked %}
                <form method="post" class="ajax-form" data-ajax="json" action="{{ url_for('unbookmark_folder', folder_id=folder.id) }}">
                  <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="submit" title="Remove from Quick access">
                    <span class="iconify" data-icon="mdi:bookmark-remove-outline"></span>
                    <span>Unpin</span>
                  </button>
                </form>
              {% else %}
                <form method="post" class="ajax-form" data-ajax="json" action="{{ url_for('bookmark_folder', folder_id=folder.id) }}">
                  <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="submit" title="Add to Quick access">
                    <span class="iconify" data-icon="mdi:bookmark-outline"></span>
                    <span>Pin</span>
                  </button>
                </form>
              {% endif %}

              <a class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" href="{{ url_for('folder_view', folder_id=folder.id) }}" title="Open">
                <span class="iconify" data-icon="mdi:chevron-right"></span>
              </a>
            </div>
          </div>
        {% else %}
          <div class="p-6">
            <div class="text-slate-900 font-semibold">No folders yet</div>
            <div class="text-slate-500 mt-1">Use New to create your first folder.</div>
          </div>
        {% endfor %}
      </div>

      <div id="explorer-folders-tiles" class="hidden p-4">
        <div id="folder-tiles" class="grid gap-3" data-tiles>
          {% for folder in folders %}
            <a class="minimal-card p-3 hover:bg-slate-50 transition-none" href="{{ url_for('folder_view', folder_id=folder.id) }}" data-folder-tile="{{ folder.id }}" data-folder-name="{{ folder.name }}" data-selectable="folder" data-open-url="{{ url_for('folder_view', folder_id=folder.id) }}">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-700 flex items-center justify-center" data-folder-tile-icon>
                  <span class="iconify" data-icon="mdi:folder-outline"></span>
                </div>
                <div class="min-w-0">
                  <div class="font-semibold text-slate-900 truncate" data-folder-tile-title>{{ folder.name }}</div>
                  <div class="text-xs text-slate-500 truncate">Folder</div>
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>

      <div class="border-t border-slate-200"></div>

    {% if not selected_folder %}
      <div id="explorer-root-files-details" class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-slate-50 text-slate-500">
              <th class="text-left font-semibold px-4 py-3 border-b border-slate-200">Name</th>
              <th class="text-left font-semibold px-4 py-3 border-b border-slate-200" data-file-col="type">Type</th>
              <th class="text-right font-semibold px-4 py-3 border-b border-slate-200" data-file-col="size">Size</th>
              <th class="text-left font-semibold px-4 py-3 border-b border-slate-200" data-file-col="modified">Modified</th>
              <th class="px-4 py-3 border-b border-slate-200"></th>
            </tr>
          </thead>
          <tbody id="root-files-table-body">
            {% for f in files %}
              <tr class="hover:bg-slate-50" data-file-row="{{ f.id }}" data-selectable="file" data-open-url="{{ url_for('download', file_id=f.id) }}">
                <td class="px-4 py-3 border-b border-slate-200 font-semibold text-slate-900" data-file-name>{{ f.original_filename }}</td>
                <td class="px-4 py-3 border-b border-slate-200 text-slate-600" data-file-col="type">{{ f.content_type or '-' }}</td>
                <td class="px-4 py-3 border-b border-slate-200 text-right text-slate-600" data-file-col="size">{% if f.size_bytes %}{{ (f.size_bytes / 1024) | round(1) }} KB{% else %}-{% endif %}</td>
                <td class="px-4 py-3 border-b border-slate-200 text-slate-600" data-file-col="modified">{{ f.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td class="px-4 py-3 border-b border-slate-200 text-right">
                  <div class="flex items-center justify-end gap-2">
                    <a class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" href="{{ url_for('download', file_id=f.id) }}">
                      <span class="iconify" data-icon="mdi:download"></span>
                      <span>Download</span>
                    </a>

                    <div class="relative" data-action-menu>
                      <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" title="More" data-action-menu-btn>
                        <span class="iconify" data-icon="mdi:dots-vertical"></span>
                      </button>
                      <div class="hidden absolute right-0 mt-2 w-44 minimal-card p-2 shadow-lg z-20" data-action-menu-pop>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-rename" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="mdi:rename-box-outline"></span>
                          <span>Rename</span>
                        </button>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-delete" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="mdi:trash-can-outline"></span>
                          <span>Delete</span>
                        </button>
                        <div class="h-px bg-slate-200 my-1"></div>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-share" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="mdi:share-variant-outline"></span>
                          <span>Share</span>
                        </button>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-cut" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="solar:scissors-square-outline"></span>
                          <span>Cut</span>
                        </button>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-copy" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="solar:copy-line-duotone"></span>
                          <span>Copy</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td class="px-4 py-6 text-slate-500" colspan="5">No files in Vault (root).</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="explorer-root-files-tiles" class="hidden p-4">
        <div id="root-files-tiles" class="grid gap-3" data-tiles>
          {% for f in files %}
            <div class="minimal-card p-3" data-file-tile="{{ f.id }}" data-size-bytes="{{ f.size_bytes or 0 }}" data-selectable="file" data-open-url="{{ url_for('download', file_id=f.id) }}">
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 min-w-0">
                  <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-700 flex items-center justify-center" data-tile-icon>
                    <span class="iconify" data-icon="mdi:file-outline"></span>
                  </div>
                  <div class="min-w-0">
                    <div class="font-semibold text-slate-900 truncate" data-file-name>{{ f.original_filename }}</div>
                    <div class="text-xs text-slate-500 truncate">{{ (f.content_type or '-') }} • {{ f.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</div>
                  </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  <a class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" href="{{ url_for('download', file_id=f.id) }}">
                    <span class="iconify" data-icon="mdi:download"></span>
                  </a>
                  <div class="relative" data-action-menu>
                    <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" title="More" data-action-menu-btn>
                      <span class="iconify" data-icon="mdi:dots-vertical"></span>
                    </button>
                    <div class="hidden absolute right-0 mt-2 w-44 minimal-card p-2 shadow-lg z-20" data-action-menu-pop>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-rename" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="mdi:rename-box-outline"></span>
                        <span>Rename</span>
                      </button>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-delete" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="mdi:trash-can-outline"></span>
                        <span>Delete</span>
                      </button>
                      <div class="h-px bg-slate-200 my-1"></div>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-share" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="mdi:share-variant-outline"></span>
                        <span>Share</span>
                      </button>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-cut" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="solar:scissors-square-outline"></span>
                        <span>Cut</span>
                      </button>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-copy" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="solar:copy-line-duotone"></span>
                        <span>Copy</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div id="explorer-folder-files-details" class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-slate-50 text-slate-500">
              <th class="text-left font-semibold px-4 py-3 border-b border-slate-200">Name</th>
              <th class="text-left font-semibold px-4 py-3 border-b border-slate-200" data-file-col="type">Type</th>
              <th class="text-right font-semibold px-4 py-3 border-b border-slate-200" data-file-col="size">Size</th>
              <th class="text-left font-semibold px-4 py-3 border-b border-slate-200" data-file-col="modified">Modified</th>
              <th class="px-4 py-3 border-b border-slate-200"></th>
            </tr>
          </thead>
          <tbody id="folder-files-table-body">
            {% for f in files %}
              <tr class="hover:bg-slate-50" data-file-row="{{ f.id }}" data-selectable="file" data-open-url="{{ url_for('download', file_id=f.id) }}">
                <td class="px-4 py-3 border-b border-slate-200 font-semibold text-slate-900" data-file-name>{{ f.original_filename }}</td>
                <td class="px-4 py-3 border-b border-slate-200 text-slate-600" data-file-col="type">{{ f.content_type or '-' }}</td>
                <td class="px-4 py-3 border-b border-slate-200 text-right text-slate-600" data-file-col="size">{% if f.size_bytes %}{{ (f.size_bytes / 1024) | round(1) }} KB{% else %}-{% endif %}</td>
                <td class="px-4 py-3 border-b border-slate-200 text-slate-600" data-file-col="modified">{{ f.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td class="px-4 py-3 border-b border-slate-200 text-right">
                  <div class="flex items-center justify-end gap-2">
                    <a class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" href="{{ url_for('download', file_id=f.id) }}">
                      <span class="iconify" data-icon="mdi:download"></span>
                      <span>Download</span>
                    </a>

                    <div class="relative" data-action-menu>
                      <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" title="More" data-action-menu-btn>
                        <span class="iconify" data-icon="mdi:dots-vertical"></span>
                      </button>
                      <div class="hidden absolute right-0 mt-2 w-44 minimal-card p-2 shadow-lg z-20" data-action-menu-pop>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-rename" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="mdi:rename-box-outline"></span>
                          <span>Rename</span>
                        </button>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-delete" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="mdi:trash-can-outline"></span>
                          <span>Delete</span>
                        </button>
                        <div class="h-px bg-slate-200 my-1"></div>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-share" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="mdi:share-variant-outline"></span>
                          <span>Share</span>
                        </button>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-cut" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="solar:scissors-square-outline"></span>
                          <span>Cut</span>
                        </button>
                        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-copy" data-file-id="{{ f.id }}">
                          <span class="iconify" data-icon="solar:copy-line-duotone"></span>
                          <span>Copy</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td class="px-4 py-6 text-slate-500" colspan="5">No files in this folder.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="explorer-folder-files-tiles" class="hidden p-4">
        <div id="folder-files-tiles" class="grid gap-3" data-tiles>
          {% for f in files %}
            <div class="minimal-card p-3" data-file-tile="{{ f.id }}" data-size-bytes="{{ f.size_bytes or 0 }}" data-selectable="file" data-open-url="{{ url_for('download', file_id=f.id) }}">
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 min-w-0">
                  <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-700 flex items-center justify-center" data-tile-icon>
                    <span class="iconify" data-icon="mdi:file-outline"></span>
                  </div>
                  <div class="min-w-0">
                    <div class="font-semibold text-slate-900 truncate" data-file-name>{{ f.original_filename }}</div>
                    <div class="text-xs text-slate-500 truncate">{{ (f.content_type or '-') }} • {{ f.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</div>
                  </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  <a class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" href="{{ url_for('download', file_id=f.id) }}">
                    <span class="iconify" data-icon="mdi:download"></span>
                  </a>
                  <div class="relative" data-action-menu>
                    <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" title="More" data-action-menu-btn>
                      <span class="iconify" data-icon="mdi:dots-vertical"></span>
                    </button>
                    <div class="hidden absolute right-0 mt-2 w-44 minimal-card p-2 shadow-lg z-20" data-action-menu-pop>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-rename" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="mdi:rename-box-outline"></span>
                        <span>Rename</span>
                      </button>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-delete" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="mdi:trash-can-outline"></span>
                        <span>Delete</span>
                      </button>
                      <div class="h-px bg-slate-200 my-1"></div>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-share" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="mdi:share-variant-outline"></span>
                        <span>Share</span>
                      </button>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-cut" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="solar:scissors-square-outline"></span>
                        <span>Cut</span>
                      </button>
                      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-copy" data-file-id="{{ f.id }}">
                        <span class="iconify" data-icon="solar:copy-line-duotone"></span>
                        <span>Copy</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      </div>
    </div>

  <div id="drop-overlay" class="hidden fixed inset-0 z-30 bg-slate-900/10"></div>
  <div id="drop-confirm" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6">
    <div class="minimal-card w-full max-w-md p-5 shadow-lg">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-slate-900" id="drop-destination">Upload</div>
        <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" id="drop-cancel-x" title="Close">
          <span class="iconify" data-icon="mdi:close"></span>
        </button>
      </div>
      <div class="mt-4 text-sm text-slate-700">
        <div class="font-semibold" id="drop-file-name">file</div>
        <div class="text-slate-500 mt-1" id="drop-file-size">size</div>
      </div>
      <div class="mt-5 flex items-center justify-end gap-2">
        <button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" id="drop-cancel">Cancel</button>
        <button class="minimal-btn minimal-btn-primary" type="button" id="drop-upload">Upload</button>
      </div>
    </div>
  </div>

  <div id="action-menu-portal" class="hidden fixed z-50"></div>
  <div id="action-menu-backdrop" class="hidden fixed inset-0 z-40 bg-slate-900/5"></div>

  <div id="context-menu-backdrop" class="hidden fixed inset-0 z-40"></div>
  <div id="explorer-context-menu" class="hidden fixed z-50 w-64">
    <div class="minimal-card p-2 shadow-lg">
      <div id="context-folder-actions" class="hidden">
        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-context-action="folder_open">
          <span class="iconify text-slate-500" data-icon="mdi:folder-open-outline"></span>
          <span class="text-sm font-semibold">Open</span>
        </button>
        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg text-slate-400 cursor-not-allowed" type="button" data-context-action="paste" id="context-paste-folder-btn" aria-disabled="true" data-disabled="1">
          <span class="iconify text-slate-500" data-icon="solar:clipboard-add-bold-duotone"></span>
          <span class="text-sm font-semibold">Paste</span>
        </button>
        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-context-action="folder_share">
          <span class="iconify text-slate-500" data-icon="mdi:share-variant-outline"></span>
          <span class="text-sm font-semibold">Share</span>
        </button>
        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-context-action="folder_rename">
          <span class="iconify text-slate-500" data-icon="mdi:rename-box-outline"></span>
          <span class="text-sm font-semibold">Rename</span>
        </button>
        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-context-action="folder_delete">
          <span class="iconify text-slate-500" data-icon="mdi:trash-can-outline"></span>
          <span class="text-sm font-semibold">Delete</span>
        </button>
        <div class="h-px bg-slate-200 my-1"></div>
        <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-context-action="folder_pin">
          <span class="iconify text-slate-500" data-icon="mdi:bookmark-outline"></span>
          <span class="text-sm font-semibold" id="context-folder-pin-label">Pin</span>
        </button>
        <div class="h-px bg-slate-200 my-1"></div>
      </div>

      <div class="relative" id="context-new-wrap">
        <button class="w-full flex items-center justify-between gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" id="context-new-btn" data-context-action="new">
          <span class="flex items-center gap-2">
            <span class="iconify text-slate-500" data-icon="solar:add-square-outline"></span>
            <span class="text-sm font-semibold">New</span>
          </span>
          <span class="iconify text-slate-400" data-icon="mdi:chevron-right"></span>
        </button>

        <div class="hidden fixed z-50 w-56" id="context-new-menu">
          <div class="minimal-card p-2 shadow-lg">
            <div class="text-xs font-semibold text-slate-500 px-3 py-2">New</div>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-context-action="new_file">
              <span class="iconify text-slate-500" data-icon="solar:file-text-line-duotone"></span>
              <span class="text-sm font-semibold">New file</span>
            </button>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-context-action="new_folder">
              <span class="iconify text-slate-500" data-icon="mdi:folder-plus-outline"></span>
              <span class="text-sm font-semibold">New folder</span>
            </button>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-context-action="upload_file">
              <span class="iconify text-slate-500" data-icon="mdi:upload"></span>
              <span class="text-sm font-semibold">Upload file</span>
            </button>
          </div>
        </div>
      </div>
      <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg text-slate-400 cursor-not-allowed" type="button" data-context-action="paste" id="context-paste-btn" aria-disabled="true" data-disabled="1">
        <span class="iconify text-slate-500" data-icon="solar:clipboard-add-bold-duotone"></span>
        <span class="text-sm font-semibold">Paste</span>
      </button>
      <div class="h-px bg-slate-200 my-1"></div>
      <div class="relative" id="context-view-wrap">
        <button class="w-full flex items-center justify-between gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" id="context-view-btn" data-context-action="view">
          <span class="flex items-center gap-2">
            <span class="iconify text-slate-500" data-icon="mdi:view-grid-outline"></span>
            <span class="text-sm font-semibold">View</span>
          </span>
          <span class="iconify text-slate-400" data-icon="mdi:chevron-right"></span>
        </button>

        <div class="hidden fixed z-50 w-56" id="context-view-menu">
          <div class="minimal-card p-2 shadow-lg">
            <div class="text-xs font-semibold text-slate-500 px-3 py-2">View</div>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-view-mode="details">
              <span class="iconify text-slate-500" data-icon="mdi:view-list"></span>
              <span class="text-sm font-semibold">Details</span>
            </button>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-view-mode="list">
              <span class="iconify text-slate-500" data-icon="mdi:format-list-bulleted"></span>
              <span class="text-sm font-semibold">List</span>
            </button>
            <div class="h-px bg-slate-200 my-1"></div>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-view-mode="tiles_small">
              <span class="iconify text-slate-500" data-icon="mdi:view-grid"></span>
              <span class="text-sm font-semibold">Small tiles</span>
            </button>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-view-mode="tiles_large">
              <span class="iconify text-slate-500" data-icon="mdi:view-grid-plus-outline"></span>
              <span class="text-sm font-semibold">Large tiles</span>
            </button>
          </div>
        </div>
      </div>
      <div class="relative" id="context-sort-wrap">
        <button class="w-full flex items-center justify-between gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" id="context-sort-btn">
          <span class="flex items-center gap-2">
            <span class="iconify text-slate-500" data-icon="solar:sort-vertical-line-duotone"></span>
            <span class="text-sm font-semibold">Sort</span>
          </span>
          <span class="iconify text-slate-400" data-icon="mdi:chevron-right"></span>
        </button>

        <div class="hidden fixed z-50 w-56" id="context-sort-menu">
          <div class="minimal-card p-2 shadow-lg">
            <div class="text-xs font-semibold text-slate-500 px-3 py-2">Sort by</div>

            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-sort-by="name">
              <span class="inline-block w-2 text-slate-900" data-sort-dot="by" data-sort-value="name"></span>
              <span class="iconify text-slate-500" data-icon="solar:text-bold-duotone"></span>
              <span class="text-sm font-semibold">Name</span>
            </button>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-sort-by="uploaded">
              <span class="inline-block w-2 text-slate-900" data-sort-dot="by" data-sort-value="uploaded"></span>
              <span class="iconify text-slate-500" data-icon="solar:calendar-line-duotone"></span>
              <span class="text-sm font-semibold">By date</span>
            </button>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-sort-by="size">
              <span class="inline-block w-2 text-slate-900" data-sort-dot="by" data-sort-value="size"></span>
              <span class="iconify text-slate-500" data-icon="solar:sort-from-bottom-to-top-line-duotone"></span>
              <span class="text-sm font-semibold">Size</span>
            </button>

            <div class="h-px bg-slate-200 my-1"></div>
            <div class="text-xs font-semibold text-slate-500 px-3 py-2">Order</div>

            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-sort-dir="asc">
              <span class="inline-block w-2 text-slate-900" data-sort-dot="dir" data-sort-value="asc"></span>
              <span class="iconify text-slate-500" data-icon="solar:arrow-up-bold-duotone"></span>
              <span class="text-sm font-semibold">Ascending</span>
            </button>
            <button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-sort-dir="desc">
              <span class="inline-block w-2 text-slate-900" data-sort-dot="dir" data-sort-value="desc"></span>
              <span class="iconify text-slate-500" data-icon="solar:arrow-down-bold-duotone"></span>
              <span class="text-sm font-semibold">Descending</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>

    function updateCurrentFolderPin(folderId, isBookmarked){
      var container = document.getElementById('current-folder-pin');
      if(!container) return;
      var currentId = container.getAttribute('data-current-folder-id');
      if(!currentId || String(currentId) !== String(folderId)) return;
      var form = container.querySelector('form.ajax-form');
      if(!form) return;
      var btn = form.querySelector('button');
      if(!btn) return;
      if(isBookmarked){
        form.setAttribute('action', '/folder/' + folderId + '/unbookmark');
        btn.setAttribute('title','Remove from Quick access');
        btn.innerHTML = '<span class="iconify" data-icon="mdi:bookmark-remove-outline"></span><span>Unpin</span>';
      }else{
        form.setAttribute('action', '/folder/' + folderId + '/bookmark');
        btn.setAttribute('title','Add to Quick access');
        btn.innerHTML = '<span class="iconify" data-icon="mdi:bookmark-outline"></span><span>Pin</span>';
      }
    }
    function toggleExplorerNewMenu(){
      var el = document.getElementById('explorer-new-menu');
      if(!el) return;
      var pid = document.getElementById('new-folder-parent-id');
      if(pid){
        pid.value = getCurrentFolderId();
      }
      el.classList.toggle('hidden');
    }

    function toggleExplorerViewMenu(){
      var el = document.getElementById('context-view-menu');
      if(!el) return;
      el.classList.toggle('hidden');
    }

    function hideExplorerContextMenu(){
      var m = document.getElementById('explorer-context-menu');
      var b = document.getElementById('context-menu-backdrop');
      if(m) m.classList.add('hidden');
      if(b) b.classList.add('hidden');
      hideExplorerSortMenu();
      hideExplorerViewMenu();
      hideExplorerNewContextMenu();
      if(m){
        m.removeAttribute('data-context-folder-id');
        m.removeAttribute('data-context-folder-open-url');
        m.removeAttribute('data-context-folder-bookmarked');
      }
    }

    function hideExplorerSortMenu(){
      var sm = document.getElementById('context-sort-menu');
      if(sm) sm.classList.add('hidden');
    }

    function hideExplorerNewContextMenu(){
      var nm = document.getElementById('context-new-menu');
      if(nm) nm.classList.add('hidden');
    }

    function showExplorerSortMenu(){
      var sm = document.getElementById('context-sort-menu');
      var btn = document.getElementById('context-sort-btn');
      if(!sm || !btn) return;

      updateExplorerSortMenuUI();

      sm.classList.remove('hidden');
      sm.style.left = '0px';
      sm.style.top = '0px';

      var vw = window.innerWidth || document.documentElement.clientWidth;
      var vh = window.innerHeight || document.documentElement.clientHeight;

      var btnRect = btn.getBoundingClientRect();
      var rect = sm.getBoundingClientRect();

      var left = btnRect.right + 8;
      var top = btnRect.top;

      if(left + rect.width + 8 > vw){
        left = btnRect.left - rect.width - 8;
      }
      if(top + rect.height + 8 > vh){
        top = vh - rect.height - 8;
      }
      if(top < 8) top = 8;
      if(left < 8) left = 8;
      if(left + rect.width + 8 > vw) left = Math.max(8, vw - rect.width - 8);

      sm.style.left = Math.round(left) + 'px';
      sm.style.top = Math.round(top) + 'px';
    }

    function showExplorerNewContextMenu(){
      var nm = document.getElementById('context-new-menu');
      var btn = document.getElementById('context-new-btn');
      if(!nm || !btn) return;

      nm.classList.remove('hidden');
      nm.style.left = '0px';
      nm.style.top = '0px';

      var vw = window.innerWidth || document.documentElement.clientWidth;
      var vh = window.innerHeight || document.documentElement.clientHeight;

      var btnRect = btn.getBoundingClientRect();
      var rect = nm.getBoundingClientRect();

      var left = btnRect.right + 8;
      var top = btnRect.top;

      if(left + rect.width + 8 > vw){
        left = btnRect.left - rect.width - 8;
      }
      if(top + rect.height + 8 > vh){
        top = vh - rect.height - 8;
      }
      if(top < 8) top = 8;
      if(left < 8) left = 8;
      if(left + rect.width + 8 > vw) left = Math.max(8, vw - rect.width - 8);

      nm.style.left = Math.round(left) + 'px';
      nm.style.top = Math.round(top) + 'px';
    }

    function getExplorerSortState(){
      var by = (localStorage.getItem('explorer_sort_by') || 'name').toLowerCase();
      var dir = (localStorage.getItem('explorer_sort_dir') || 'asc').toLowerCase();
      if(by !== 'name' && by !== 'uploaded' && by !== 'size') by = 'name';
      if(dir !== 'asc' && dir !== 'desc') dir = 'asc';
      return { by: by, dir: dir };
    }

    function setExplorerSortState(next){
      if(!next) return;
      if(next.by) localStorage.setItem('explorer_sort_by', String(next.by));
      if(next.dir) localStorage.setItem('explorer_sort_dir', String(next.dir));
    }

    function updateExplorerSortMenuUI(){
      var sm = document.getElementById('context-sort-menu');
      if(!sm) return;
      var st = getExplorerSortState();
      sm.querySelectorAll('[data-sort-dot="by"]').forEach(function(el){
        el.textContent = (el.getAttribute('data-sort-value') === st.by) ? '•' : '';
      });
      sm.querySelectorAll('[data-sort-dot="dir"]').forEach(function(el){
        el.textContent = (el.getAttribute('data-sort-value') === st.dir) ? '•' : '';
      });
    }

    function showExplorerContextMenu(x, y){
      var m = document.getElementById('explorer-context-menu');
      var b = document.getElementById('context-menu-backdrop');
      if(!m || !b) return;

      var pasteBtn = document.getElementById('context-paste-btn');
      var pasteFolderBtn = document.getElementById('context-paste-folder-btn');
      var hasCtxFolder = !!(m.getAttribute('data-context-folder-id') || '');
      if(pasteBtn){
        var clip = getFileClipboard();
        if(clip && clip.fileId && (clip.mode === 'cut' || clip.mode === 'copy')){
          pasteBtn.setAttribute('aria-disabled','false');
          pasteBtn.removeAttribute('data-disabled');
          pasteBtn.classList.remove('text-slate-400','cursor-not-allowed');
          pasteBtn.classList.add('hover:bg-slate-100','text-slate-800');
        }else{
          pasteBtn.setAttribute('aria-disabled','true');
          pasteBtn.setAttribute('data-disabled','1');
          pasteBtn.classList.add('text-slate-400','cursor-not-allowed');
          pasteBtn.classList.remove('hover:bg-slate-100','text-slate-800');
        }
        pasteBtn.classList.toggle('hidden', hasCtxFolder);
      }

      if(pasteFolderBtn){
        var clip2 = getFileClipboard();
        if(clip2 && clip2.fileId && (clip2.mode === 'cut' || clip2.mode === 'copy')){
          pasteFolderBtn.setAttribute('aria-disabled','false');
          pasteFolderBtn.removeAttribute('data-disabled');
          pasteFolderBtn.classList.remove('text-slate-400','cursor-not-allowed');
          pasteFolderBtn.classList.add('hover:bg-slate-100','text-slate-800');
        }else{
          pasteFolderBtn.setAttribute('aria-disabled','true');
          pasteFolderBtn.setAttribute('data-disabled','1');
          pasteFolderBtn.classList.add('text-slate-400','cursor-not-allowed');
          pasteFolderBtn.classList.remove('hover:bg-slate-100','text-slate-800');
        }
        pasteFolderBtn.classList.toggle('hidden', !hasCtxFolder);
      }

      var folderSection = document.getElementById('context-folder-actions');
      if(folderSection){
        folderSection.classList.toggle('hidden', !m.getAttribute('data-context-folder-id'));
        var pinLabel = document.getElementById('context-folder-pin-label');
        if(pinLabel){
          pinLabel.textContent = (m.getAttribute('data-context-folder-bookmarked') === '1') ? 'Unpin' : 'Pin';
        }
      }

      b.classList.remove('hidden');
      m.classList.remove('hidden');
      m.style.left = '0px';
      m.style.top = '0px';
      var vw = window.innerWidth || document.documentElement.clientWidth;
      var vh = window.innerHeight || document.documentElement.clientHeight;
      var rect = m.getBoundingClientRect();

      var left = x;
      var top = y;

      if(left + rect.width + 8 > vw){
        left = x - rect.width;
      }
      if(top + rect.height + 8 > vh){
        top = y - rect.height;
      }

      left = Math.max(8, Math.min(left, vw - rect.width - 8));
      top = Math.max(8, Math.min(top, vh - rect.height - 8));

      m.style.left = left + 'px';
      m.style.top = top + 'px';
    }

    function isActionClick(target){
      if(!target) return false;
      if(target.closest('form')) return true;
      if(target.closest('button')) return true;
      if(target.closest('[data-action-menu]')) return true;
      if(target.closest('a.minimal-btn')) return true;
      if(target.closest('#explorer-live-results')) return true;
      return false;
    }

    var __selectedEl = null;
    var __selectedRowCells = null;
    function clearSelection(){
      if(__selectedEl){
        __selectedEl.classList.remove('bg-indigo-50','ring-2','ring-indigo-500');
        __selectedEl = null;
      }

      if(__selectedRowCells){
        try{
          __selectedRowCells.tds.forEach(function(td){
            td.classList.remove('bg-indigo-50');
          });
          if(__selectedRowCells.first){
            __selectedRowCells.first.classList.remove('border-l-4','border-indigo-500');
          }
        } catch(e) {}
        __selectedRowCells = null;
      }
    }

    function selectItem(el){
      if(!el) return;
      if(__selectedEl === el) return;
      clearSelection();
      __selectedEl = el;

      if(el.tagName === 'TR'){
        var tds = Array.prototype.slice.call(el.querySelectorAll('td'));
        tds.forEach(function(td){ td.classList.add('bg-indigo-50'); });
        var first = tds.length ? tds[0] : null;
        if(first) first.classList.add('border-l-4','border-indigo-500');
        __selectedRowCells = { tds: tds, first: first };
      }else{
        el.classList.add('bg-indigo-50','ring-2','ring-indigo-500');
      }
    }

    function updateViewMenuActive(mode){
      var menu = document.getElementById('context-view-menu');
      if(!menu) return;
      menu.querySelectorAll('button[data-view-mode]').forEach(function(btn){
        btn.classList.remove('bg-slate-100');
      });
      var active = menu.querySelector('button[data-view-mode="'+mode+'"]');
      if(active) active.classList.add('bg-slate-100');
    }

    function hideExplorerViewMenu(){
      var vm = document.getElementById('context-view-menu');
      if(vm) vm.classList.add('hidden');
    }

    function showExplorerViewMenu(){
      var vm = document.getElementById('context-view-menu');
      var btn = document.getElementById('context-view-btn');
      if(!vm || !btn) return;

      var mode = (localStorage.getItem('vault_view_mode') || 'details');
      updateViewMenuActive(mode);

      vm.classList.remove('hidden');
      vm.style.left = '0px';
      vm.style.top = '0px';

      var vw = window.innerWidth || document.documentElement.clientWidth;
      var vh = window.innerHeight || document.documentElement.clientHeight;

      var btnRect = btn.getBoundingClientRect();
      var rect = vm.getBoundingClientRect();

      var left = btnRect.right + 8;
      var top = btnRect.top;

      if(left + rect.width + 8 > vw){
        left = btnRect.left - rect.width - 8;
      }
      if(top + rect.height + 8 > vh){
        top = vh - rect.height - 8;
      }
      if(top < 8) top = 8;
      if(left < 8) left = 8;
      if(left + rect.width + 8 > vw) left = Math.max(8, vw - rect.width - 8);

      vm.style.left = Math.round(left) + 'px';
      vm.style.top = Math.round(top) + 'px';
    }

    function applyExplorerViewMode(mode){
      var foldersDetails = document.getElementById('explorer-folders-details');
      var foldersTiles = document.getElementById('explorer-folders-tiles');
      var rootFilesDetails = document.getElementById('explorer-root-files-details');
      var rootFilesTiles = document.getElementById('explorer-root-files-tiles');
      var folderFilesDetails = document.getElementById('explorer-folder-files-details');
      var folderFilesTiles = document.getElementById('explorer-folder-files-tiles');

      var allowed = { details: 1, list: 1, tiles_small: 1, tiles_large: 1 };
      if(!allowed[mode]) mode = 'details';

      var showTiles = (mode === 'tiles_small' || mode === 'tiles_large');
      var isList = (mode === 'list');

      if(foldersDetails && foldersTiles){
        foldersDetails.classList.toggle('hidden', showTiles);
        foldersTiles.classList.toggle('hidden', !showTiles);
      }

      if(rootFilesDetails && rootFilesTiles){
        rootFilesDetails.classList.toggle('hidden', showTiles);
        rootFilesTiles.classList.toggle('hidden', !showTiles);
      }

      if(folderFilesDetails && folderFilesTiles){
        folderFilesDetails.classList.toggle('hidden', showTiles);
        folderFilesTiles.classList.toggle('hidden', !showTiles);
      }

      document.querySelectorAll('[data-tiles]').forEach(function(grid){
        if(mode === 'tiles_large'){
          grid.className = 'grid gap-4 sm:grid-cols-2 lg:grid-cols-3';
        }else{
          grid.className = 'grid gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4';
        }
      });

      document.querySelectorAll('[data-tile-icon]').forEach(function(icon){
        icon.classList.remove('w-8','h-8','w-10','h-10','w-12','h-12');
        if(mode === 'tiles_large'){
          icon.classList.add('w-12','h-12');
        }else if(mode === 'tiles_small'){
          icon.classList.add('w-8','h-8');
        }else{
          icon.classList.add('w-10','h-10');
        }
      });

      document.querySelectorAll('[data-file-col]').forEach(function(el){
        el.classList.toggle('hidden', isList && !showTiles);
      });
      document.querySelectorAll('[data-folder-subtitle]').forEach(function(el){
        el.classList.toggle('hidden', isList && !showTiles);
      });

      var scroll = document.querySelector('.flex-1.min-h-0.overflow-auto');
      if(scroll){
        scroll.classList.toggle('text-sm', isList);
      }

      updateViewMenuActive(mode);
    }

    document.addEventListener('dblclick', function(ev){
      if(isActionClick(ev.target)) return;
      var selectable = ev.target.closest('[data-selectable][data-open-url]');
      if(!selectable) return;
      if(selectable.tagName === 'A') ev.preventDefault();
      var url = selectable.getAttribute('data-open-url');
      if(url) window.location.href = url;
    });

    (function(){
      var area = document.getElementById('explorer-content-area');
      if(!area) return;
      area.addEventListener('contextmenu', function(ev){
        var onSelectable = ev.target.closest('[data-selectable]');
        var onAction = isActionClick(ev.target);
        if(onAction) return;
        ev.preventDefault();
        closeAllActionMenus();
        var menu = document.getElementById('explorer-context-menu');
        if(menu){
          if(onSelectable && onSelectable.getAttribute('data-selectable') === 'folder'){
            var folderEl = ev.target.closest('[data-folder-row],[data-folder-tile]') || onSelectable;
            var folderId = (folderEl.getAttribute('data-folder-row') || folderEl.getAttribute('data-folder-tile') || '').trim();
            menu.setAttribute('data-context-folder-id', folderId);
            menu.setAttribute('data-context-folder-open-url', folderEl.getAttribute('data-open-url') || '');
            menu.setAttribute('data-context-folder-bookmarked', folderEl.getAttribute('data-folder-bookmarked') || '0');
          }else{
            menu.removeAttribute('data-context-folder-id');
            menu.removeAttribute('data-context-folder-open-url');
            menu.removeAttribute('data-context-folder-bookmarked');
          }
        }
        showExplorerContextMenu(ev.clientX, ev.clientY);
      });

      var backdrop = document.getElementById('context-menu-backdrop');
      if(backdrop){
        backdrop.addEventListener('click', function(){
          hideExplorerContextMenu();
        });

        backdrop.addEventListener('contextmenu', function(ev){
          ev.preventDefault();
          closeAllActionMenus();
          hideExplorerSortMenu();

          var menu = document.getElementById('explorer-context-menu');
          if(!menu) return;

          var prev = backdrop.style.pointerEvents;
          backdrop.style.pointerEvents = 'none';
          var under = document.elementFromPoint(ev.clientX, ev.clientY);
          backdrop.style.pointerEvents = prev;

          var onSelectable = under ? under.closest('[data-selectable]') : null;
          if(onSelectable && onSelectable.getAttribute('data-selectable') === 'folder'){
            var folderEl = under.closest('[data-folder-row],[data-folder-tile]') || onSelectable;
            var folderId = (folderEl.getAttribute('data-folder-row') || folderEl.getAttribute('data-folder-tile') || '').trim();
            menu.setAttribute('data-context-folder-id', folderId);
            menu.setAttribute('data-context-folder-open-url', folderEl.getAttribute('data-open-url') || '');
            menu.setAttribute('data-context-folder-bookmarked', folderEl.getAttribute('data-folder-bookmarked') || '0');
          }else{
            menu.removeAttribute('data-context-folder-id');
            menu.removeAttribute('data-context-folder-open-url');
            menu.removeAttribute('data-context-folder-bookmarked');
          }

          showExplorerContextMenu(ev.clientX, ev.clientY);
        });
      }

      document.addEventListener('keydown', function(ev){
        if(ev.key === 'Escape') hideExplorerContextMenu();
      });
      window.addEventListener('scroll', function(){ hideExplorerContextMenu(); }, true);
    })();

    (function(){
      var wrap = document.getElementById('context-new-wrap');
      if(!wrap) return;
      var menu = document.getElementById('context-new-menu');
      if(!menu) return;

      var hideTimer = null;
      function cancelHide(){
        if(hideTimer){
          clearTimeout(hideTimer);
          hideTimer = null;
        }
      }
      function scheduleHide(){
        cancelHide();
        hideTimer = setTimeout(function(){
          hideExplorerNewContextMenu();
        }, 140);
      }

      function isOverNewArea(target){
        if(!target || !target.closest) return false;
        if(target.closest('#context-new-wrap')) return true;
        if(target.closest('#context-new-menu')) return true;
        return false;
      }

      wrap.addEventListener('mouseenter', function(){
        cancelHide();
        showExplorerNewContextMenu();
      });
      wrap.addEventListener('mouseleave', function(){
        scheduleHide();
      });

      menu.addEventListener('mouseenter', function(){
        cancelHide();
      });
      menu.addEventListener('mouseleave', function(){
        scheduleHide();
      });

      var cm = document.getElementById('explorer-context-menu');
      if(cm){
        cm.addEventListener('mousemove', function(ev){
          if(isOverNewArea(ev.target)) return;
          var onOption = ev.target && ev.target.closest ? ev.target.closest('button') : null;
          if(onOption){
            hideExplorerNewContextMenu();
          }
        }, true);

        cm.addEventListener('mouseleave', function(){
          scheduleHide();
        });
      }
    })();

    function closeAllActionMenus(){
      document.querySelectorAll('[data-action-menu-pop]').forEach(function(p){
        p.classList.add('hidden');
      });

      var portal = document.getElementById('action-menu-portal');
      if(portal){
        portal.classList.add('hidden');
        portal.innerHTML = '';
        portal.style.left = '';
        portal.style.top = '';
        portal.style.maxHeight = '';
        portal.style.visibility = '';
        portal.style.opacity = '';
      }
      var backdrop = document.getElementById('action-menu-backdrop');
      if(backdrop) backdrop.classList.add('hidden');
    }

    function formatBytes(bytes){
      var n = Number(bytes || 0);
      if(!n) return '0 B';
      var units = ['B','KB','MB','GB','TB'];
      var i = Math.floor(Math.log(n)/Math.log(1024));
      i = Math.min(i, units.length - 1);
      var val = n / Math.pow(1024, i);
      return (i === 0 ? String(n) : val.toFixed(1)) + ' ' + units[i];
    }

    function showDropConfirm(file){
      var modal = document.getElementById('drop-confirm');
      var overlay = document.getElementById('drop-overlay');
      if(!modal || !overlay) return;
      var destEl = document.getElementById('drop-destination');
      var nameEl = document.getElementById('drop-file-name');
      var sizeEl = document.getElementById('drop-file-size');
      if(destEl) destEl.textContent = window.__dropDestinationLabel || 'Upload';
      if(nameEl) nameEl.textContent = file ? file.name : '';
      if(sizeEl) sizeEl.textContent = file ? formatBytes(file.size) : '';
      overlay.classList.remove('hidden');
      modal.classList.remove('hidden');
    }

    function hideDropConfirm(){
      var modal = document.getElementById('drop-confirm');
      var overlay = document.getElementById('drop-overlay');
      if(overlay) overlay.classList.add('hidden');
      if(modal) modal.classList.add('hidden');
    }

    function addFileRowTo(tbodyId, file){
      var tbody = document.getElementById(tbodyId);
      if(!tbody) return;
      var tr = document.createElement('tr');
      tr.className = 'hover:bg-slate-50';
      tr.setAttribute('data-file-row', file.id);
      var sizeText = (file.size_bytes ? (file.size_bytes / 1024).toFixed(1) + ' KB' : '-');
      tr.innerHTML = ''+
        '<td class="px-4 py-3 border-b border-slate-200 font-semibold text-slate-900" data-file-name></td>'+
        '<td class="px-4 py-3 border-b border-slate-200 text-slate-600">'+(file.content_type || '-')+'</td>'+
        '<td class="px-4 py-3 border-b border-slate-200 text-right text-slate-600">'+sizeText+'</td>'+
        '<td class="px-4 py-3 border-b border-slate-200 text-slate-600">'+(file.uploaded_at || '')+'</td>'+
        '<td class="px-4 py-3 border-b border-slate-200 text-right">'+
          '<div class="flex items-center justify-end gap-2">'+
            '<a class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" href="/file/'+file.id+'/download">'+
              '<span class="iconify" data-icon="mdi:download"></span><span>Download</span>'+
            '</a>'+
            '<div class="relative" data-action-menu>'+
              '<button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" title="More" data-action-menu-btn><span class="iconify" data-icon="mdi:dots-vertical"></span></button>'+
              '<div class="hidden absolute right-0 mt-2 w-44 minimal-card p-2 shadow-lg z-20" data-action-menu-pop>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-rename" data-file-id="'+file.id+'"><span class="iconify" data-icon="mdi:rename-box-outline"></span><span>Rename</span></button>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-delete" data-file-id="'+file.id+'"><span class="iconify" data-icon="mdi:trash-can-outline"></span><span>Delete</span></button>'+
                '<div class="h-px bg-slate-200 my-1"></div>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-share" data-file-id="'+file.id+'"><span class="iconify" data-icon="mdi:share-variant-outline"></span><span>Share</span></button>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-cut" data-file-id="'+file.id+'"><span class="iconify" data-icon="solar:scissors-square-outline"></span><span>Cut</span></button>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-copy" data-file-id="'+file.id+'"><span class="iconify" data-icon="solar:copy-line-duotone"></span><span>Copy</span></button>'+
              '</div>'+
            '</div>'+
          '</div>'+
        '</td>';
      tr.querySelector('[data-file-name]').textContent = file.original_filename;
      tbody.prepend(tr);
    }

    function addFileTileTo(containerId, file){
      var container = document.getElementById(containerId);
      if(!container) return;
      var div = document.createElement('div');
      div.className = 'minimal-card p-3';
      div.setAttribute('data-size-bytes', String(file.size_bytes || 0));
      div.setAttribute('data-file-tile', file.id);
      div.setAttribute('data-selectable', 'file');
      div.setAttribute('data-open-url', '/file/' + file.id + '/download');
      div.innerHTML = ''+
        '<div class="flex items-center justify-between gap-3">'+
          '<div class="flex items-center gap-3 min-w-0">'+
            '<div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-700 flex items-center justify-center" data-tile-icon><span class="iconify" data-icon="mdi:file-outline"></span></div>'+
            '<div class="min-w-0">'+
              '<div class="font-semibold text-slate-900 truncate" data-file-name></div>'+
              '<div class="text-xs text-slate-500 truncate"></div>'+
            '</div>'+
          '</div>'+
          '<div class="flex items-center gap-2 shrink-0">'+
            '<a class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" href="/file/'+file.id+'/download"><span class="iconify" data-icon="mdi:download"></span></a>'+
            '<div class="relative" data-action-menu>'+
              '<button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="button" title="More" data-action-menu-btn><span class="iconify" data-icon="mdi:dots-vertical"></span></button>'+
              '<div class="hidden absolute right-0 mt-2 w-44 minimal-card p-2 shadow-lg z-20" data-action-menu-pop>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-rename" data-file-id="'+file.id+'"><span class="iconify" data-icon="mdi:rename-box-outline"></span><span>Rename</span></button>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-delete" data-file-id="'+file.id+'"><span class="iconify" data-icon="mdi:trash-can-outline"></span><span>Delete</span></button>'+
                '<div class="h-px bg-slate-200 my-1"></div>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-share" data-file-id="'+file.id+'"><span class="iconify" data-icon="mdi:share-variant-outline"></span><span>Share</span></button>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-cut" data-file-id="'+file.id+'"><span class="iconify" data-icon="solar:scissors-square-outline"></span><span>Cut</span></button>'+
                '<button class="w-full flex items-center gap-2 text-left px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-800" type="button" data-action="file-copy" data-file-id="'+file.id+'"><span class="iconify" data-icon="solar:copy-line-duotone"></span><span>Copy</span></button>'+
              '</div>'+
            '</div>'+
          '</div>'+
        '</div>';
      div.querySelector('[data-file-name]').textContent = file.original_filename;
      var meta = div.querySelector('.text-xs');
      if(meta) meta.textContent = (file.content_type || '-') + (file.uploaded_at ? (' • ' + file.uploaded_at) : '');
      container.prepend(div);

      var mode = localStorage.getItem('vault_view_mode') || 'details';
      applyExplorerViewMode(mode);
    }

    (function(){
      var rootFolderId = '{{ root_folder_id or "" }}';
      var selectedFolderId = '{{ selected_folder_id or "" }}';
      var selectedFolderName = '{{ selected_folder.name if selected_folder else "" }}';
      var dropFile = null;
      var overlay = document.getElementById('drop-overlay');

      function getDropTarget(){
        if(selectedFolderId){
          window.__dropDestinationLabel = 'Upload to ' + (selectedFolderName ? selectedFolderName : 'this folder');
          return { folderId: selectedFolderId, tbodyId: 'folder-files-table-body', tilesId: 'folder-files-tiles' };
        }
        window.__dropDestinationLabel = 'Upload to Vault (root)';
        return { folderId: rootFolderId, tbodyId: 'root-files-table-body', tilesId: 'root-files-tiles' };
      }

      function showOverlay(){
        if(overlay) overlay.classList.remove('hidden');
      }

      function hideOverlay(){
        var modal = document.getElementById('drop-confirm');
        if(modal && !modal.classList.contains('hidden')) return;
        if(overlay) overlay.classList.add('hidden');
      }

      document.addEventListener('dragenter', function(ev){
        if(!ev.dataTransfer) return;
        if(!ev.dataTransfer.types || Array.prototype.indexOf.call(ev.dataTransfer.types,'Files') === -1) return;
        ev.preventDefault();
        showOverlay();
      });

      document.addEventListener('dragover', function(ev){
        if(!ev.dataTransfer) return;
        if(!ev.dataTransfer.types || Array.prototype.indexOf.call(ev.dataTransfer.types,'Files') === -1) return;
        ev.preventDefault();
      });

      document.addEventListener('dragleave', function(ev){
        if(!ev.dataTransfer) return;
        if(ev.target === document.documentElement){
          hideOverlay();
        }
      });

      document.addEventListener('drop', function(ev){
        if(!ev.dataTransfer) return;
        if(!ev.dataTransfer.files || !ev.dataTransfer.files.length) return;
        ev.preventDefault();
        hideOverlay();
        var target = getDropTarget();
        if(!target.folderId){
          alert('Upload folder not available.');
          return;
        }
        dropFile = ev.dataTransfer.files[0];
        showDropConfirm(dropFile);
      });

      var cancel = document.getElementById('drop-cancel');
      var cancelX = document.getElementById('drop-cancel-x');
      if(cancel) cancel.addEventListener('click', function(){ dropFile = null; hideDropConfirm(); });
      if(cancelX) cancelX.addEventListener('click', function(){ dropFile = null; hideDropConfirm(); });
      if(overlay) overlay.addEventListener('click', function(){ dropFile = null; hideDropConfirm(); closeAllActionMenus(); });

      var uploadBtn = document.getElementById('drop-upload');
      if(uploadBtn) uploadBtn.addEventListener('click', async function(){
        if(!dropFile) return;
        var target = getDropTarget();
        if(!target.folderId){
          alert('Upload folder not available.');
          return;
        }
        uploadBtn.disabled = true;
        try{
          var fd = new FormData();
          fd.append('folder_id', target.folderId);
          fd.append('file', dropFile);
          var res = await fetch('/upload', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }, body: fd });
          var data = await res.json().catch(function(){ return null; });
          if(!res.ok || !data || data.ok === false){
            alert((data && data.error) ? data.error : 'Upload failed');
            return;
          }
          if(data.file){
            addFileRowTo(target.tbodyId, data.file);
            addFileTileTo(target.tilesId, data.file);
          }
          hideDropConfirm();
          dropFile = null;
        } finally {
          uploadBtn.disabled = false;
        }
      });
    })();

    document.addEventListener('click', async function(ev){
      if(!isActionClick(ev.target)){
        var selectable = ev.target.closest('[data-selectable][data-open-url]');
        if(selectable){
          if(selectable.tagName === 'A') ev.preventDefault();
          selectItem(selectable);
          return;
        }
        if(!ev.target.closest('[data-selectable]')){
          clearSelection();
        }
      }

      var ctxAction = ev.target.closest('button[data-context-action]');
      if(ctxAction){
        ev.preventDefault();
        var a = ctxAction.getAttribute('data-context-action');
        var cm = document.getElementById('explorer-context-menu');
        var ctxFolderId = cm ? (cm.getAttribute('data-context-folder-id') || '') : '';
        var ctxFolderOpenUrl = cm ? (cm.getAttribute('data-context-folder-open-url') || '') : '';
        var ctxFolderBookmarked = cm ? (cm.getAttribute('data-context-folder-bookmarked') === '1') : false;
        var rootFolderId = '{{ root_folder_id or "" }}';
        var currentFolderEl = document.getElementById('current-folder-pin');
        var selectedFolderId = currentFolderEl ? (currentFolderEl.getAttribute('data-current-folder-id') || '') : '';

        if(a === 'new'){
          showExplorerNewContextMenu();
          return;
        }

        if(a === 'view'){
          showExplorerViewMenu();
          return;
        }

        hideExplorerContextMenu();

        if(a === 'new_file'){
          var targetFolderId = ctxFolderId || selectedFolderId || rootFolderId;
          if(!targetFolderId) return;
          var fname = prompt('New file name', 'New file.txt');
          if(fname === null) return;
          fname = String(fname).trim();
          if(!fname) return;
          var created = await postAction('/file/new', { folder_id: targetFolderId, name: fname });
          if(!created || !created.file) return;
          var isCurrentTarget = String(targetFolderId) === String(selectedFolderId || rootFolderId);
          if(isCurrentTarget){
            addFileRowTo(selectedFolderId ? 'folder-files-table-body' : 'root-files-table-body', created.file);
            addFileTileTo(selectedFolderId ? 'folder-files-tiles' : 'root-files-tiles', created.file);
          }
          notify('Created: ' + (created.file.original_filename || fname) + '.');
          return;
        }

        if(a === 'folder_open'){
          if(ctxFolderOpenUrl) window.location.href = ctxFolderOpenUrl;
          return;
        }
        if(a === 'folder_share'){
          if(!ctxFolderId) return;
          var share = await createShareLink('folder', ctxFolderId);
          if(!share) return;
          await copyText(share.url);
          alert('Share link created (copied):\n' + share.url + '\n\nExpires: ' + (share.expires_at || ''));
          return;
        }
        if(a === 'folder_rename'){
          if(!ctxFolderId) return;
          var row = document.querySelector('[data-folder-row="'+ctxFolderId+'"]');
          var currentName = row ? (row.getAttribute('data-folder-name') || '') : '';
          var name = prompt('Rename folder', currentName || '');
          if(name === null) return;
          name = String(name).trim();
          if(!name) return;
          postAction('/folder/' + ctxFolderId + '/rename', { name: name }).then(function(data){
            if(!data || !data.folder) return;
            updateRowFolderName(data.folder.id, data.folder.name);
            var tile = document.querySelector('[data-folder-tile="'+data.folder.id+'"]');
            if(tile){
              tile.setAttribute('data-folder-name', data.folder.name);
              var t = tile.querySelector('[data-folder-tile-title]');
              if(t) t.textContent = data.folder.name;
            }
            sidebarRename(data.folder.id, data.folder.name);
          });
          return;
        }
        if(a === 'folder_delete'){
          if(!ctxFolderId) return;
          if(!confirm('Delete this folder and all its files?')) return;
          postAction('/folder/' + ctxFolderId + '/delete', {}).then(function(){
            removeFolderRow(ctxFolderId);
            var tileDel = document.querySelector('[data-folder-tile="'+ctxFolderId+'"]');
            if(tileDel) tileDel.remove();
            sidebarRemove(ctxFolderId);
          });
          return;
        }
        if(a === 'folder_pin'){
          if(!ctxFolderId) return;
          var url = '/folder/' + ctxFolderId + (ctxFolderBookmarked ? '/unbookmark' : '/bookmark');
          postAction(url, {}).then(function(data){
            if(!data) return;
            var folderId = data.folder_id;
            var name = data.name;
            if(data.is_bookmarked){
              sidebarUpsert(folderId, name);
            }else{
              sidebarRemove(folderId);
            }
            updateRowBookmarkState(folderId, data.is_bookmarked);
            updateCurrentFolderPin(folderId, data.is_bookmarked);
          });
          return;
        }

        if(a === 'paste'){
          if(ctxAction.getAttribute('data-disabled') === '1' || ctxAction.getAttribute('aria-disabled') === 'true'){
            notify('Nothing to paste. Use Copy/Cut on a file first.');
            return;
          }
          var target = getPasteTargetFromUI();
          await performPasteInto(target.folderId, target.folderName);
          return;
        }

        if(a === 'new_folder'){
          var menu = document.getElementById('explorer-new-menu');
          if(menu && menu.classList.contains('hidden')) toggleExplorerNewMenu();
          var input = document.getElementById('new-folder-input');
          if(input) input.focus();
          return;
        }
        if(a === 'upload_file'){
          var menu2 = document.getElementById('explorer-new-menu');
          if(menu2 && menu2.classList.contains('hidden')) toggleExplorerNewMenu();
          var fileInput = document.getElementById('new-upload-file-input');
          if(fileInput) fileInput.click();
          return;
        }
      }

      var viewModeBtn = ev.target.closest('button[data-view-mode]');
      if(viewModeBtn){
        ev.preventDefault();
        var mode = viewModeBtn.getAttribute('data-view-mode') || 'details';
        localStorage.setItem('vault_view_mode', mode);
        applyExplorerViewMode(mode);
        hideExplorerViewMenu();
        return;
      }

      var menu = document.getElementById('explorer-new-menu');
      if(menu && !menu.classList.contains('hidden')){
        var inside = ev.target.closest('#explorer-new-menu');
        var btn = ev.target.closest('button');
        if(inside) return;
        if(btn && btn.getAttribute('onclick') && btn.getAttribute('onclick').includes('toggleExplorerNewMenu')) return;
        menu.classList.add('hidden');
      }

      var viewMenu = document.getElementById('context-view-menu');
      if(viewMenu && !viewMenu.classList.contains('hidden')){
        var insideView = ev.target.closest('#context-view-menu');
        var btnView = ev.target.closest('#context-view-btn');
        if(insideView) return;
        if(btnView) return;
        hideExplorerViewMenu();
      }

      var actionBtn = ev.target.closest('[data-action-menu-btn]');
      if(actionBtn){
        ev.preventDefault();
        hideExplorerContextMenu();
        var container = actionBtn.closest('[data-action-menu]');
        var pop = container ? container.querySelector('[data-action-menu-pop]') : null;
        if(!pop) return;

        var portal = document.getElementById('action-menu-portal');
        var backdrop = document.getElementById('action-menu-backdrop');
        if(!portal || !backdrop) return;

        var alreadyOpen = !portal.classList.contains('hidden');
        closeAllActionMenus();
        if(alreadyOpen) return;

        portal.innerHTML = '<div class="minimal-card p-2 shadow-lg w-44">' + pop.innerHTML + '</div>';
        portal.style.transition = 'none';
        portal.style.left = '-9999px';
        portal.style.top = '-9999px';
        portal.style.visibility = 'hidden';
        portal.style.opacity = '0';
        portal.classList.remove('hidden');
        backdrop.classList.remove('hidden');

        portal.style.maxHeight = (window.innerHeight - 16) + 'px';

        var rect = actionBtn.getBoundingClientRect();
        var vw = window.innerWidth;
        var vh = window.innerHeight;
        var pad = 8;

        var content = portal.firstElementChild;
        var pr = (content ? content.getBoundingClientRect() : portal.getBoundingClientRect());

        var left = rect.right - pr.width;
        if(left < pad) left = pad;
        if(left + pr.width > vw - pad) left = Math.max(pad, vw - pad - pr.width);

        var top = rect.bottom + pad;
        if(top + pr.height > vh - pad){
          top = rect.top - pad - pr.height;
        }
        if(top < pad) top = pad;
        if(top + pr.height > vh - pad) top = Math.max(pad, vh - pad - pr.height);

        portal.style.left = left + 'px';
        portal.style.top = top + 'px';
        portal.style.visibility = 'visible';
        portal.style.opacity = '1';
        return;
      }

      if(!ev.target.closest('[data-action-menu-pop]') && !ev.target.closest('#action-menu-portal')){
        closeAllActionMenus();
      }

      var sortBtn = ev.target.closest('#context-sort-btn');
      if(sortBtn){
        ev.preventDefault();
        showExplorerSortMenu();
        return;
      }

      var newBtn = ev.target.closest('#context-new-btn');
      if(newBtn){
        ev.preventDefault();
        showExplorerNewContextMenu();
        return;
      }

      var viewBtn = ev.target.closest('#context-view-btn');
      if(viewBtn){
        ev.preventDefault();
        showExplorerViewMenu();
        return;
      }

      var sortByChoice = ev.target.closest('button[data-sort-by]');
      if(sortByChoice){
        ev.preventDefault();
        setExplorerSortState({ by: sortByChoice.getAttribute('data-sort-by') || 'name' });
        updateExplorerSortMenuUI();
        applyExplorerSortFromState();
        hideExplorerContextMenu();
        return;
      }

      var sortDirChoice = ev.target.closest('button[data-sort-dir]');
      if(sortDirChoice){
        ev.preventDefault();
        setExplorerSortState({ dir: sortDirChoice.getAttribute('data-sort-dir') || 'asc' });
        updateExplorerSortMenuUI();
        applyExplorerSortFromState();
        hideExplorerContextMenu();
        return;
      }
    });

    document.addEventListener('keydown', async function(ev){
      var k = (ev.key || '').toLowerCase();
      if(!(ev.ctrlKey || ev.metaKey)) return;
      var active = document.activeElement;
      if(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return;

      if(k === 'c' || k === 'x'){
        var fileId = getSelectedFileId();
        if(!fileId) return;
        ev.preventDefault();
        var mode = (k === 'x') ? 'cut' : 'copy';
        var fromFolderId = getCurrentFolderId();
        window.__fileClipboard = { mode: mode, fileId: String(fileId), fromFolderId: String(fromFolderId) };
        saveFileClipboard(window.__fileClipboard);
        await writeDeviceClipboard(window.__fileClipboard);
        notify((mode === 'cut' ? 'Cut' : 'Copied') + '. Now paste with Ctrl+V or context menu.');
        return;
      }

      if(k === 'v'){
        ev.preventDefault();
        var target = getPasteTargetFromUI();
        await performPasteInto(target.folderId, target.folderName);
        return;
      }
    });

    (function(){
      var wrap = document.getElementById('context-sort-wrap');
      if(!wrap) return;
      var menu = document.getElementById('context-sort-menu');
      if(!menu) return;

      var hideTimer = null;
      function cancelHide(){
        if(hideTimer){
          clearTimeout(hideTimer);
          hideTimer = null;
        }
      }
      function scheduleHide(){
        cancelHide();
        hideTimer = setTimeout(function(){
          hideExplorerSortMenu();
        }, 140);
      }

      function isOverSortArea(target){
        if(!target || !target.closest) return false;
        if(target.closest('#context-sort-wrap')) return true;
        if(target.closest('#context-sort-menu')) return true;
        return false;
      }

      wrap.addEventListener('mouseenter', function(){
        cancelHide();
        showExplorerSortMenu();
      });
      wrap.addEventListener('mouseleave', function(){
        scheduleHide();
      });

      menu.addEventListener('mouseenter', function(){
        cancelHide();
      });
      menu.addEventListener('mouseleave', function(){
        scheduleHide();
      });

      var cm = document.getElementById('explorer-context-menu');
      if(cm){
        cm.addEventListener('mousemove', function(ev){
          if(isOverSortArea(ev.target)) return;
          var onOption = ev.target && ev.target.closest ? ev.target.closest('button') : null;
          if(onOption){
            hideExplorerSortMenu();
          }
        }, true);

        cm.addEventListener('mouseleave', function(){
          scheduleHide();
        });
      }
    })();

    (function(){
      var wrap = document.getElementById('context-view-wrap');
      if(!wrap) return;
      var menu = document.getElementById('context-view-menu');
      if(!menu) return;

      var hideTimer = null;
      function cancelHide(){
        if(hideTimer){
          clearTimeout(hideTimer);
          hideTimer = null;
        }
      }
      function scheduleHide(){
        cancelHide();
        hideTimer = setTimeout(function(){
          hideExplorerViewMenu();
        }, 140);
      }

      function isOverViewArea(target){
        if(!target || !target.closest) return false;
        if(target.closest('#context-view-wrap')) return true;
        if(target.closest('#context-view-menu')) return true;
        return false;
      }

      wrap.addEventListener('mouseenter', function(){
        cancelHide();
        showExplorerViewMenu();
      });
      wrap.addEventListener('mouseleave', function(){
        scheduleHide();
      });

      menu.addEventListener('mouseenter', function(){
        cancelHide();
      });
      menu.addEventListener('mouseleave', function(){
        scheduleHide();
      });

      var cm = document.getElementById('explorer-context-menu');
      if(cm){
        cm.addEventListener('mousemove', function(ev){
          if(isOverViewArea(ev.target)) return;
          var onOption = ev.target && ev.target.closest ? ev.target.closest('button') : null;
          if(onOption){
            hideExplorerViewMenu();
          }
        }, true);

        cm.addEventListener('mouseleave', function(){
          scheduleHide();
        });
      }
    })();

    function parseSortableNumber(txt){
      if(txt === null || txt === undefined) return 0;
      var s = String(txt).trim();
      if(!s) return 0;
      var m = s.match(/([0-9]+(\.[0-9]+)?)/);
      if(!m) return 0;
      return parseFloat(m[1]) || 0;
    }

    function compareText(a, b){
      a = (a || '').toString().toLowerCase();
      b = (b || '').toString().toLowerCase();
      if(a < b) return -1;
      if(a > b) return 1;
      return 0;
    }

    function sortChildren(container, items, cmp){
      items.sort(cmp);
      for(var i=0;i<items.length;i++){
        container.appendChild(items[i].el);
      }
    }

    function applyExplorerSortFromState(){
      var st = getExplorerSortState();
      var key = '';

      if(st.by === 'name') key = 'files_name_' + st.dir;
      else if(st.by === 'uploaded') key = 'files_uploaded_' + st.dir;
      else if(st.by === 'size') key = 'files_size_' + st.dir;

      applyExplorerSortKey(key, st);
    }

    function applyExplorerSortKey(key, st){
      if(!key) return;
      var currentFolderEl = document.getElementById('current-folder-pin');
      var selectedFolderId = currentFolderEl ? (currentFolderEl.getAttribute('data-current-folder-id') || '') : '';
      var mode = localStorage.getItem('vault_view_mode') || 'details';
      var showTiles = (mode === 'tiles_small' || mode === 'tiles_large');

      if(!selectedFolderId && st && st.by === 'name'){
        var fkey = 'folders_name_' + (st.dir || 'asc');
        if(showTiles){
          var tiles = document.getElementById('folder-tiles');
          if(tiles){
            var items = Array.prototype.slice.call(tiles.querySelectorAll('[data-folder-tile]')).map(function(el){
              var t = el.querySelector('[data-folder-tile-title]');
              return { el: el, name: (t ? t.textContent : (el.getAttribute('data-folder-name') || '')) };
            });
            if(fkey === 'folders_name_asc') sortChildren(tiles, items, function(x,y){ return compareText(x.name, y.name); });
            if(fkey === 'folders_name_desc') sortChildren(tiles, items, function(x,y){ return compareText(y.name, x.name); });
          }
        }else{
          var list = document.getElementById('explorer-folders-details');
          if(list){
            var rows = Array.prototype.slice.call(list.querySelectorAll('[data-folder-row]')).map(function(el){
              var t = el.querySelector('[data-folder-title]');
              return { el: el, name: (t ? t.textContent : (el.getAttribute('data-folder-name') || '')) };
            });
            if(fkey === 'folders_name_asc') sortChildren(list, rows, function(x,y){ return compareText(x.name, y.name); });
            if(fkey === 'folders_name_desc') sortChildren(list, rows, function(x,y){ return compareText(y.name, x.name); });
          }
        }
      }

      if(key.indexOf('files_') === 0){
        var tbodyId = selectedFolderId ? 'folder-files-table-body' : 'root-files-table-body';
        var tilesId = selectedFolderId ? 'folder-files-tiles' : 'root-files-tiles';
        if(showTiles){
          var tiles2 = document.getElementById(tilesId);
          if(!tiles2) return;
          var cards = Array.prototype.slice.call(tiles2.querySelectorAll('[data-file-tile]')).map(function(el){
            var nameEl = el.querySelector('[data-file-name]');
            var name = nameEl ? nameEl.textContent : '';
            var meta = el.querySelector('.text-xs');
            var metaText = meta ? meta.textContent : '';
            var type = metaText.split('•')[0].trim();
            var size = parseInt(el.getAttribute('data-size-bytes') || '0', 10) || 0;
            var uploaded = '';
            if(metaText.indexOf('•') !== -1){
              uploaded = metaText.split('•').slice(1).join('•').trim();
            }
            return { el: el, name: name, type: type, modified: metaText, uploaded: uploaded, size: size };
          });
          if(key === 'files_name_asc') sortChildren(tiles2, cards, function(x,y){ return compareText(x.name, y.name); });
          if(key === 'files_name_desc') sortChildren(tiles2, cards, function(x,y){ return compareText(y.name, x.name); });
          if(key === 'files_size_desc') sortChildren(tiles2, cards, function(x,y){ return (y.size - x.size) || compareText(x.name, y.name); });
          if(key === 'files_size_asc') sortChildren(tiles2, cards, function(x,y){ return (x.size - y.size) || compareText(x.name, y.name); });
          if(key === 'files_uploaded_desc') sortChildren(tiles2, cards, function(x,y){ return compareText(y.uploaded, x.uploaded) || compareText(x.name, y.name); });
          if(key === 'files_uploaded_asc') sortChildren(tiles2, cards, function(x,y){ return compareText(x.uploaded, y.uploaded) || compareText(x.name, y.name); });
          return;
        }

        var tbody = document.getElementById(tbodyId);
        if(!tbody) return;
        var rows2 = Array.prototype.slice.call(tbody.querySelectorAll('tr[data-file-row]')).map(function(tr){
          var nameEl = tr.querySelector('[data-file-name]');
          var typeEl = tr.querySelector('[data-file-col="type"]');
          var sizeEl = tr.querySelector('[data-file-col="size"]');
          var modEl = tr.querySelector('[data-file-col="modified"]');
          return {
            el: tr,
            name: nameEl ? nameEl.textContent : '',
            type: typeEl ? typeEl.textContent : '',
            size: parseSortableNumber(sizeEl ? sizeEl.textContent : ''),
            modified: modEl ? modEl.textContent : ''
          };
        });

        if(key === 'files_name_asc') sortChildren(tbody, rows2, function(x,y){ return compareText(x.name, y.name); });
        if(key === 'files_name_desc') sortChildren(tbody, rows2, function(x,y){ return compareText(y.name, x.name); });
        if(key === 'files_size_desc') sortChildren(tbody, rows2, function(x,y){ return (y.size - x.size) || compareText(x.name, y.name); });
        if(key === 'files_size_asc') sortChildren(tbody, rows2, function(x,y){ return (x.size - y.size) || compareText(x.name, y.name); });
        if(key === 'files_uploaded_desc') sortChildren(tbody, rows2, function(x,y){ return compareText(y.modified, x.modified) || compareText(x.name, y.name); });
        if(key === 'files_uploaded_asc') sortChildren(tbody, rows2, function(x,y){ return compareText(x.modified, y.modified) || compareText(x.name, y.name); });
      }
    }

    function sidebarRename(folderId, name){
      var nav = document.getElementById('quick-access-folders');
      if(!nav) return;
      var existing = nav.querySelector('[data-sidebar-folder="'+folderId+'"]');
      if(!existing) return;
      var label = existing.querySelector('span.truncate');
      if(label) label.textContent = name;
    }

    function updateRowFolderName(folderId, name){
      var row = document.querySelector('[data-folder-row="'+folderId+'"]');
      if(!row) return;
      row.setAttribute('data-folder-name', name);
      var label = row.querySelector('.truncate');
      if(label) label.textContent = name;
    }

    function removeFolderRow(folderId){
      var row = document.querySelector('[data-folder-row="'+folderId+'"]');
      if(row) row.remove();
    }

    function updateFileRowName(fileId, name){
      var row = document.querySelector('[data-file-row="'+fileId+'"]');
      if(!row) return;
      var label = row.querySelector('[data-file-name]');
      if(label) label.textContent = name;
    }

    function removeFileRow(fileId){
      var row = document.querySelector('[data-file-row="'+fileId+'"]');
      if(row) row.remove();
    }

    async function postAction(url, params){
      var options = {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json',
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: new URLSearchParams(params || {}).toString()
      };
      var res = await fetch(url, options);
      var data = await res.json().catch(function(){ return null; });
      if(!res.ok || !data || data.ok === false){
        alert((data && data.error) ? data.error : 'Request failed');
        return null;
      }
      return data;
    }

    async function createShareLink(itemType, itemId){
      var minutes = prompt('Share duration (minutes)', '30');
      if(minutes === null) return null;
      minutes = String(minutes).trim();
      if(!minutes) minutes = '30';
      var data = await postAction('/share', { item_type: itemType, item_id: itemId, minutes: minutes });
      if(!data || !data.share || !data.share.url) return null;
      return data.share;
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        try{
          var ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          return true;
        }catch(e2){
          return false;
        }
      }
    }

    function notify(msg){
      if(!msg) return;
      alert(msg);
    }

    function loadFileClipboard(){
      try{
        var raw = localStorage.getItem('vault_file_clipboard');
        if(!raw) return null;
        var obj = JSON.parse(raw);
        if(!obj || !obj.fileId || !(obj.mode === 'cut' || obj.mode === 'copy')) return null;
        return obj;
      }catch(e){
        return null;
      }
    }

    function buildDeviceClipboardPayload(obj){
      try{
        return 'VAULTCLIP:' + JSON.stringify(obj);
      }catch(e){
        return '';
      }
    }

    async function writeDeviceClipboard(obj){
      try{
        if(!obj) return false;
        var payload = buildDeviceClipboardPayload(obj);
        if(!payload) return false;
        await navigator.clipboard.writeText(payload);
        return true;
      }catch(e){
        return false;
      }
    }

    async function readDeviceClipboard(){
      try{
        var txt = await navigator.clipboard.readText();
        if(!txt) return null;
        txt = String(txt);
        if(txt.indexOf('VAULTCLIP:') !== 0) return null;
        var raw = txt.slice('VAULTCLIP:'.length);
        var obj = JSON.parse(raw);
        if(!obj || !obj.fileId || !(obj.mode === 'cut' || obj.mode === 'copy')) return null;
        return obj;
      }catch(e){
        return null;
      }
    }

    function saveFileClipboard(obj){
      try{
        if(!obj){
          localStorage.removeItem('vault_file_clipboard');
          return;
        }
        localStorage.setItem('vault_file_clipboard', JSON.stringify(obj));
      }catch(e){
      }
    }

    function getFileClipboard(){
      if(window.__fileClipboard && window.__fileClipboard.fileId) return window.__fileClipboard;
      var restored = loadFileClipboard();
      if(restored){
        window.__fileClipboard = restored;
        return restored;
      }
      return null;
    }

    function clearFileClipboard(){
      window.__fileClipboard = null;
      saveFileClipboard(null);
    }

    (function(){
      var restored = loadFileClipboard();
      if(restored) window.__fileClipboard = restored;
    })();

    function getSelectedFileId(){
      if(!__selectedEl) return '';
      if(__selectedEl.getAttribute){
        var selectable = __selectedEl.getAttribute('data-selectable') || '';
        if(selectable !== 'file') return '';
        var rowId = __selectedEl.getAttribute('data-file-row');
        if(rowId) return String(rowId);
        var tileId = __selectedEl.getAttribute('data-file-tile');
        if(tileId) return String(tileId);
      }
      return '';
    }

    function getCurrentFolderId(){
      var currentFolderEl = document.getElementById('current-folder-pin');
      var selectedFolderId = currentFolderEl ? (currentFolderEl.getAttribute('data-current-folder-id') || '') : '';
      var rootFolderId = '{{ root_folder_id or "" }}';
      return selectedFolderId ? selectedFolderId : rootFolderId;
    }

    function getPasteTargetFromUI(){
      var cm = document.getElementById('explorer-context-menu');
      var ctxFolderId = cm ? (cm.getAttribute('data-context-folder-id') || '') : '';
      var targetFolderId = ctxFolderId || getCurrentFolderId();
      var targetFolderName = '';
      if(ctxFolderId){
        var folderEl = document.querySelector('[data-folder-row="'+ctxFolderId+'"], [data-folder-tile="'+ctxFolderId+'"]');
        targetFolderName = folderEl ? (folderEl.getAttribute('data-folder-name') || '') : '';
      }
      if(!targetFolderName){
        targetFolderName = (getCurrentFolderId() === '{{ root_folder_id or "" }}') ? 'Vault (root)' : 'this folder';
      }
      return { folderId: targetFolderId, folderName: targetFolderName };
    }

    async function performPasteInto(targetFolderId, targetFolderName){
      if(!targetFolderId) return;

      var clip = getFileClipboard();
      if(!clip){
        var fromDevice = await readDeviceClipboard();
        if(fromDevice){
          window.__fileClipboard = fromDevice;
          saveFileClipboard(fromDevice);
          clip = fromDevice;
        }
      }

      if(!clip || !clip.fileId || !(clip.mode === 'cut' || clip.mode === 'copy')){
        notify('Nothing to paste. Use Copy/Cut on a file first.');
        return;
      }

      if(clip.mode === 'cut' && String(targetFolderId) === String(clip.fromFolderId)){
        clearFileClipboard();
        notify('Clipboard cleared (same folder).');
        return;
      }

      var currentFolderId = getCurrentFolderId();
      var isCurrentTarget = String(targetFolderId) === String(currentFolderId);

      var endpoint = (clip.mode === 'cut') ? ('/file/' + clip.fileId + '/move') : ('/file/' + clip.fileId + '/copy');
      var dataPaste = await postAction(endpoint, { folder_id: targetFolderId });
      if(!dataPaste || !dataPaste.file) return;

      if(clip.mode === 'cut'){
        removeFileRow(clip.fileId);
        var oldTile = document.querySelector('[data-file-tile="'+clip.fileId+'"]');
        if(oldTile) oldTile.remove();
        if(isCurrentTarget){
          addFileRowTo((currentFolderId === '{{ root_folder_id or "" }}') ? 'root-files-table-body' : 'folder-files-table-body', dataPaste.file);
          addFileTileTo((currentFolderId === '{{ root_folder_id or "" }}') ? 'root-files-tiles' : 'folder-files-tiles', dataPaste.file);
        }
        clearFileClipboard();
        notify('Moved to ' + (targetFolderName || 'destination') + '.');
        return;
      }

      if(isCurrentTarget){
        addFileRowTo((currentFolderId === '{{ root_folder_id or "" }}') ? 'root-files-table-body' : 'folder-files-table-body', dataPaste.file);
        addFileTileTo((currentFolderId === '{{ root_folder_id or "" }}') ? 'root-files-tiles' : 'folder-files-tiles', dataPaste.file);
      }
      notify('Copied to ' + (targetFolderName || 'destination') + '.');
    }

    document.addEventListener('click', async function(ev){
      var btn = ev.target.closest('button[data-action]');
      if(!btn) return;
      var action = btn.getAttribute('data-action');
      if(!action) return;

      if(action === 'file-cut' || action === 'file-copy'){
        ev.preventDefault();
        closeAllActionMenus();
        var fileIdClip = btn.getAttribute('data-file-id');
        if(!fileIdClip) return;
        var currentFolderEl = document.getElementById('current-folder-pin');
        var selectedFolderId = currentFolderEl ? (currentFolderEl.getAttribute('data-current-folder-id') || '') : '';
        var rootFolderId = '{{ root_folder_id or "" }}';
        var fromFolderId = selectedFolderId ? selectedFolderId : rootFolderId;
        window.__fileClipboard = { mode: (action === 'file-cut') ? 'cut' : 'copy', fileId: String(fileIdClip), fromFolderId: String(fromFolderId) };
        saveFileClipboard(window.__fileClipboard);

        await writeDeviceClipboard(window.__fileClipboard);

        var rowClip = document.querySelector('[data-file-row="'+fileIdClip+'"]');
        var tileClip = document.querySelector('[data-file-tile="'+fileIdClip+'"]');
        var nameClip = '';
        if(rowClip){
          var n = rowClip.querySelector('[data-file-name]');
          nameClip = n ? n.textContent : '';
        }else if(tileClip){
          var n2 = tileClip.querySelector('[data-file-name]');
          nameClip = n2 ? n2.textContent : '';
        }
        if(nameClip) await copyText(nameClip);
        notify(((action === 'file-cut') ? 'Cut' : 'Copied') + (nameClip ? (': ' + nameClip) : '') + '. Now right-click a folder and choose Paste.');
        return;
      }

      if(action === 'folder-rename'){
        ev.preventDefault();
        closeAllActionMenus();
        var folderId = btn.getAttribute('data-folder-id');
        var row = document.querySelector('[data-folder-row="'+folderId+'"]');
        var currentName = row ? row.getAttribute('data-folder-name') : '';
        var name = prompt('Rename folder', currentName || '');
        if(name === null) return;
        name = String(name).trim();
        if(!name) return;
        var data = await postAction('/folder/' + folderId + '/rename', { name: name });
        if(!data || !data.folder) return;
        updateRowFolderName(data.folder.id, data.folder.name);
        var tile = document.querySelector('[data-folder-tile="'+data.folder.id+'"]');
        if(tile){
          tile.setAttribute('data-folder-name', data.folder.name);
          var t = tile.querySelector('[data-folder-tile-title]');
          if(t) t.textContent = data.folder.name;
        }
        sidebarRename(data.folder.id, data.folder.name);
        return;
      }

      if(action === 'folder-delete'){
        ev.preventDefault();
        closeAllActionMenus();
        var folderIdDel = btn.getAttribute('data-folder-id');
        if(!confirm('Delete this folder and all its files?')) return;
        var dataDel = await postAction('/folder/' + folderIdDel + '/delete', {});
        if(!dataDel) return;
        removeFolderRow(folderIdDel);
        var tileDel = document.querySelector('[data-folder-tile="'+folderIdDel+'"]');
        if(tileDel) tileDel.remove();
        sidebarRemove(folderIdDel);
        return;
      }

      if(action === 'file-rename'){
        ev.preventDefault();
        closeAllActionMenus();
        var fileId = btn.getAttribute('data-file-id');
        var rowFile = document.querySelector('[data-file-row="'+fileId+'"]');
        var label = rowFile ? rowFile.querySelector('[data-file-name]') : null;
        var currentFileName = label ? label.textContent : '';
        var newFileName = prompt('Rename file', currentFileName || '');
        if(newFileName === null) return;
        newFileName = String(newFileName).trim();
        if(!newFileName) return;
        var dataFile = await postAction('/file/' + fileId + '/rename', { name: newFileName });
        if(!dataFile || !dataFile.file) return;
        updateFileRowName(dataFile.file.id, dataFile.file.original_filename);
        var fileTile = document.querySelector('[data-file-tile="'+dataFile.file.id+'"]');
        if(fileTile){
          var nameEl = fileTile.querySelector('[data-file-name]');
          if(nameEl) nameEl.textContent = dataFile.file.original_filename;
        }
        return;
      }

      if(action === 'file-delete'){
        ev.preventDefault();
        closeAllActionMenus();
        var fileIdDel = btn.getAttribute('data-file-id');
        if(!confirm('Delete this file?')) return;
        var dataFileDel = await postAction('/file/' + fileIdDel + '/delete', {});
        if(!dataFileDel) return;
        removeFileRow(fileIdDel);
        var fileTileDel = document.querySelector('[data-file-tile="'+fileIdDel+'"]');
        if(fileTileDel) fileTileDel.remove();
        return;
      }

      if(action === 'file-share'){
        ev.preventDefault();
        closeAllActionMenus();
        var fileIdShare = btn.getAttribute('data-file-id');
        if(!fileIdShare) return;
        var share = await createShareLink('file', fileIdShare);
        if(!share) return;
        await copyText(share.url);
        alert('Share link created (copied):\n' + share.url + '\n\nExpires: ' + (share.expires_at || ''));
        return;
      }
    });

    function sidebarUpsert(folderId, name){
      var nav = document.getElementById('quick-access-folders');
      if(!nav) return;
      var existing = nav.querySelector('[data-sidebar-folder="'+folderId+'"]');
      if(existing) return;

      var a = document.createElement('a');
      a.className = 'minimal-nav-item';
      a.setAttribute('href', '/folder/' + folderId);
      a.setAttribute('data-sidebar-folder', folderId);
      a.innerHTML = '<span class="iconify" data-icon="mdi:folder-outline"></span><span class="truncate"></span>';
      a.querySelector('span.truncate').textContent = name;
      nav.insertBefore(a, nav.querySelector('[data-sidebar-search]'));
    }

    function sidebarRemove(folderId){
      var nav = document.getElementById('quick-access-folders');
      if(!nav) return;
      var existing = nav.querySelector('[data-sidebar-folder="'+folderId+'"]');
      if(existing) existing.remove();
    }

    function updateRowBookmarkState(folderId, isBookmarked){
      var row = document.querySelector('[data-folder-row="'+folderId+'"]');
      if(!row) return;
      row.setAttribute('data-folder-bookmarked', isBookmarked ? '1' : '0');
      var form = row.querySelector('form.ajax-form[action*="/bookmark"], form.ajax-form[action*="/unbookmark"]');
      if(!form) return;
      var btn = form.querySelector('button');
      if(!btn) return;

      if(isBookmarked){
        form.setAttribute('action', '/folder/' + folderId + '/unbookmark');
        btn.setAttribute('title','Remove from Quick access');
        btn.innerHTML = '<span class="iconify" data-icon="mdi:bookmark-remove-outline"></span><span>Unpin</span>';
      }else{
        form.setAttribute('action', '/folder/' + folderId + '/bookmark');
        btn.setAttribute('title','Add to Quick access');
        btn.innerHTML = '<span class="iconify" data-icon="mdi:bookmark-outline"></span><span>Pin</span>';
      }
    }

    async function submitAjaxForm(form){
      var ajaxType = form.getAttribute('data-ajax') || 'json';
      var url = form.getAttribute('action');

      var options = { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } };
      if(ajaxType === 'multipart'){
        options.body = new FormData(form);
      }else{
        options.headers['Content-Type'] = 'application/x-www-form-urlencoded;charset=UTF-8';
        options.body = new URLSearchParams(new FormData(form)).toString();
      }

      var res = await fetch(url, options);
      var data = await res.json().catch(function(){ return null; });
      if(!res.ok || !data || data.ok === false){
        alert((data && data.error) ? data.error : 'Request failed');
        return;
      }

      if(url.includes('/bookmark') || url.includes('/unbookmark')){
        var folderId = data.folder_id;
        var name = data.name;
        if(data.is_bookmarked){
          sidebarUpsert(folderId, name);
        }else{
          sidebarRemove(folderId);
        }
        updateRowBookmarkState(folderId, data.is_bookmarked);
        updateCurrentFolderPin(folderId, data.is_bookmarked);
      }

      if(url.endsWith('/folders')){
        var folder = data.folder;
        if(folder && folder.id){
          var list = document.getElementById('explorer-folders-details');
          if(list){
            var div = document.createElement('div');
            div.className = 'px-4 py-3 flex items-center justify-between gap-4 hover:bg-slate-50';
            div.setAttribute('data-folder-row', folder.id);
            div.setAttribute('data-folder-name', folder.name);
            div.setAttribute('data-folder-bookmarked', folder.is_bookmarked ? '1' : '0');
            div.setAttribute('data-selectable', 'folder');
            div.setAttribute('data-open-url', '/folder/' + folder.id);
            div.innerHTML = '<a class="flex items-center gap-3 min-w-0 flex-1" href="/folder/'+folder.id+'">'+
              '<div class="w-8 h-8 rounded-xl bg-indigo-50 text-indigo-700 flex items-center justify-center"><span class="iconify" data-icon="mdi:folder-outline"></span></div>'+
              '<div class="min-w-0"><div class="font-semibold text-slate-900 truncate"></div><div class="text-xs text-slate-500"></div></div></a>'+
              '<div class="flex items-center gap-2">'+
              '<form method="post" class="ajax-form" data-ajax="json" action="/folder/'+folder.id+'/bookmark">'+
              '<button class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" type="submit" title="Add to Quick access"><span class="iconify" data-icon="mdi:bookmark-outline"></span><span>Pin</span></button>'+
              '</form>'+
              '<a class="minimal-btn bg-slate-100 hover:bg-slate-200 text-slate-800" href="/folder/'+folder.id+'" title="Open"><span class="iconify" data-icon="mdi:chevron-right"></span></a>'+
              '</div>';
            div.querySelector('.truncate').textContent = folder.name;
            div.querySelector('.text-xs').textContent = 'Created ' + folder.created_at;
            list.prepend(div);
          }

          var tiles = document.getElementById('folder-tiles');
          if(tiles){
            var tile = document.createElement('a');
            tile.className = 'minimal-card p-3 hover:bg-slate-50 transition-none';
            tile.href = '/folder/' + folder.id;
            tile.setAttribute('data-folder-tile', folder.id);
            tile.setAttribute('data-folder-name', folder.name);
            tile.setAttribute('data-selectable', 'folder');
            tile.setAttribute('data-open-url', '/folder/' + folder.id);
            tile.innerHTML = '<div class="flex items-center gap-3">'+
              '<div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-700 flex items-center justify-center" data-folder-tile-icon><span class="iconify" data-icon="mdi:folder-outline"></span></div>'+
              '<div class="min-w-0"><div class="font-semibold text-slate-900 truncate" data-folder-tile-title></div><div class="text-xs text-slate-500 truncate">Folder</div></div>'+
              '</div>';
            tile.querySelector('[data-folder-tile-title]').textContent = folder.name;
            tiles.prepend(tile);
          }

          var select = document.querySelector('#explorer-new-menu select[name="folder_id"]');
          if(select){
            var opt = document.createElement('option');
            opt.value = folder.id;
            opt.textContent = folder.name;
            select.appendChild(opt);
          }
        }
        form.reset();
        var menu = document.getElementById('explorer-new-menu');
        if(menu) menu.classList.add('hidden');
      }

      if(url.includes('/upload')){
        form.reset();
        var menu = document.getElementById('explorer-new-menu');
        if(menu) menu.classList.add('hidden');
      }
    }

    document.addEventListener('submit', function(ev){
      var form = ev.target.closest('form.ajax-form');
      if(!form) return;
      ev.preventDefault();
      submitAjaxForm(form);
    });

    (function(){
      var input = document.getElementById('explorer-search-input');
      var panel = document.getElementById('explorer-live-results');
      if(!input || !panel) return;

      var timer = null;
      var activeIndex = -1;

      function hide(){
        panel.classList.add('hidden');
        panel.innerHTML = '';
        activeIndex = -1;
      }

      function show(){
        if(panel.innerHTML.trim()) panel.classList.remove('hidden');
      }

      function setActive(idx){
        var items = panel.querySelectorAll('[data-live-item]');
        items.forEach(function(el){ el.classList.remove('bg-slate-100'); });
        if(idx >= 0 && idx < items.length){
          items[idx].classList.add('bg-slate-100');
          activeIndex = idx;
        }else{
          activeIndex = -1;
        }
      }

      function render(results, q){
        panel.innerHTML = '';
        if(!q){
          hide();
          return;
        }

        if(!results || !results.length){
          panel.innerHTML = '<div class="px-3 py-2 text-sm text-slate-500">No results</div>';
          show();
          return;
        }

        results.forEach(function(r, idx){
          var a = document.createElement('a');
          a.href = r.download_url || '#';
          a.setAttribute('data-live-item','1');
          a.setAttribute('data-open-folder', r.open_folder_url || '');
          a.className = 'block px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-900';
          a.innerHTML = ''+
            '<div class="flex items-center justify-between gap-3">'+
              '<div class="min-w-0">'+
                '<div class="text-sm font-semibold truncate"></div>'+
                '<div class="text-xs text-slate-500 truncate"></div>'+
              '</div>'+
              '<div class="text-xs text-slate-500 shrink-0">'+(r.uploaded_at || '')+'</div>'+
            '</div>';
          a.querySelector('.font-semibold').textContent = r.name || '';
          a.querySelector('.text-xs').textContent = (r.folder && r.folder.name ? r.folder.name : '') + (r.content_type ? (' • ' + r.content_type) : '');
          panel.appendChild(a);
        });
        show();
        setActive(-1);
      }

      async function fetchResults(){
        var q = (input.value || '').trim();
        if(!q){
          hide();
          return;
        }
        var url = '/search?format=json&q=' + encodeURIComponent(q);
        var res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
        var data = await res.json().catch(function(){ return null; });
        if(!res.ok || !data || data.ok === false){
          hide();
          return;
        }
        render(data.results || [], q);
      }

      input.addEventListener('input', function(){
        if(timer) clearTimeout(timer);
        timer = setTimeout(fetchResults, 180);
      });

      input.addEventListener('focus', function(){
        if(panel.innerHTML.trim()) panel.classList.remove('hidden');
      });

      document.addEventListener('click', function(ev){
        if(ev.target.closest('#explorer-live-results') || ev.target.closest('#explorer-search-input')) return;
        hide();
      });

      input.addEventListener('keydown', function(ev){
        if(panel.classList.contains('hidden')) return;
        var items = panel.querySelectorAll('[data-live-item]');
        if(!items.length) return;

        if(ev.key === 'ArrowDown'){
          ev.preventDefault();
          setActive(Math.min(activeIndex + 1, items.length - 1));
          return;
        }
        if(ev.key === 'ArrowUp'){
          ev.preventDefault();
          setActive(Math.max(activeIndex - 1, 0));
          return;
        }
        if(ev.key === 'Escape'){
          hide();
          return;
        }
        if(ev.key === 'Enter'){
          if(activeIndex >= 0 && activeIndex < items.length){
            ev.preventDefault();
            window.location.href = items[activeIndex].getAttribute('href');
          }
        }
      });

      panel.addEventListener('click', function(ev){
        var a = ev.target.closest('a[data-live-item]');
        if(!a) return;
        hide();
      });
    })();

    (function(){
      var mode = localStorage.getItem('vault_view_mode') || 'details';
      applyExplorerViewMode(mode);
    })();
  </script>
  </div>
{% endblock %}
